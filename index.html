<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNV LT Courts Schedule (Multi-Tab)</title>
  <!-- Chart.js for plot visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    :root { 
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-light: #f8fafc;
      --card: #ffffff; 
      --text: #1e293b; 
      --muted: #64748b; 
      --primary: #6366f1; 
      --primary-600: #4f46e5; 
      --primary-700: #4338ca; 
      --primary-light: #eef2ff;
      --ring: #e2e8f0; 
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
      margin: 0; 
      padding: 0;
      background: var(--bg-light);
      color: var(--text); 
      line-height: 1.6;
    }
    .app { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 2rem 1.5rem 140px; 
      background: var(--bg-light);
    }
    h1 { 
      margin: 0 0 0.5rem 0; 
      font-size: 2rem; 
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.02em;
    }
    .hint { 
      color: var(--muted); 
      font-size: 0.95rem; 
      margin-bottom: 1.5rem;
      font-weight: 500;
    }
    .navbar { 
      position: sticky; 
      top: 0; 
      z-index: 999; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      background: var(--card); 
      border-bottom: 1px solid var(--ring); 
      padding: 10px 16px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .navbar .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -0.02em;
    }
    .navbar .brand span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px; height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      color: #fff; font-weight: 800;
    }
    .navbar .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .navbar a, .navbar button { 
      background: var(--primary-600); 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      padding: 11px 20px; 
      font-weight: 600; 
      font-size: 0.9rem;
      cursor: pointer; 
      text-decoration: none; 
      transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      min-width: 100px;
      text-align: center;
    }
    .navbar a:hover, .navbar button:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--shadow-md);
    }
    .navbar .secondary { 
      background: var(--primary-light); 
      color: var(--text); 
      border: 1px solid var(--ring); 
    }
    #table-view-btn, #plot-view-btn { 
      background: var(--primary-light); 
      color: var(--text); 
      border: 1px solid var(--ring); 
    }
    #table-view-btn.active, #plot-view-btn.active { 
      background: var(--primary-600); 
      color: #fff; 
      border: 1px solid var(--primary-600);
    }

    /* Segmented toggle for week filter */
    .segmented {
      display: inline-flex;
      border: 1px solid var(--ring);
      border-radius: 10px;
      overflow: hidden;
      background: var(--primary-light);
    }
    .segmented button {
      background: transparent;
      color: var(--text);
      border: none;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      min-width: auto;
    }
    .segmented button + button { border-left: 1px solid var(--ring); }
    .segmented button.active {
      background: var(--primary-600);
      color: #fff;
    }
    /* Floating expandable day selector (similar to original app) */
    .tab-buttons {
      position: fixed;
      bottom: 28px;
      left: 28px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      border-radius: 50%;
      box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4), 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 80vh;
      overflow-y: auto;
      width: 84px;
      height: 84px;
      padding: 0;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 3px solid rgba(255,255,255,0.2);
    }
    .tab-buttons:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(79, 70, 229, 0.5), 0 4px 12px rgba(0,0,0,0.2);
    }
    .tab-buttons.expanded {
      border-radius: 20px;
      width: auto;
      height: auto;
      padding: 14px;
      background: rgba(255,255,255,0.95);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid var(--ring);
      box-shadow: var(--shadow-lg);
    }
    .tab-buttons::before {
      content: attr(data-day);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      color: white;
      cursor: pointer;
      z-index: 1001;
      font-weight: 600;
      text-align: center;
      width: 100%;
    }
    .tab-buttons.expanded::before {
      content: "âœ•";
      font-size: 1.2rem;
      left: 10px;
      transform: translateY(-50%);
      color: #333;
      width: auto;
    }
    .tab-buttons button {
      padding: 10px 18px;
      background: #fff;
      color: var(--text);
      border: 1px solid var(--ring);
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      opacity: 0;
      transform: translateX(-20px);
      pointer-events: none;
      margin-left: 30px;
      display: none;
      box-shadow: var(--shadow-sm);
    }
    .tab-buttons button:hover {
      background: var(--primary-light);
      transform: translateX(0) translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .tab-buttons.expanded button { 
      opacity: 1; 
      transform: translateX(0); 
      pointer-events: auto; 
      display: block; 
    }
    .tab-buttons button.active { 
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); 
      color: #fff; 
      border-color: var(--primary-600);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .date-title { 
      font-size: 1.15rem; 
      font-weight: 700;
      color: var(--primary-700); 
      margin: 1.5rem 0 0.75rem; 
      padding: 8px 12px;
      padding-left: 16px;
      border-left: 5px solid var(--primary-600); 
      background: linear-gradient(90deg, var(--primary-light) 0%, transparent 100%);
      border-radius: 8px;
    }
    table { 
      width: 100%; 
      background: var(--card); 
      border-radius: 14px; 
      overflow: hidden; 
      box-shadow: var(--shadow-md); 
      border-collapse: separate; 
      font-size: 1.08rem; 
      margin-bottom: 1.25rem; 
      border: 1px solid var(--ring); 
    }
    th, td { 
      padding: 16px 20px; 
      text-align: center; 
    }
    th { 
      position: sticky; 
      top: 0; 
      z-index: 1; 
      background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%); 
      color: #0f172a; 
      text-transform: uppercase; 
      font-size: 0.95rem; 
      letter-spacing: 0.05em; 
      font-weight: 700;
      border-bottom: 2px solid var(--ring);
    }
    tbody tr {
      transition: all 0.2s ease;
    }
    tbody tr:hover {
      background: var(--primary-light) !important;
      transform: scale(1.01);
    }
    tr:nth-child(even) td { 
      background: #f8fafc; 
    }
    td {
      border-bottom: 1px solid #f1f5f9;
      color: #0f172a;
      font-weight: 600;
      line-height: 1.6;
    }

    /* Plot container as card */
    #plot-container { 
      background: var(--card); 
      border: 1px solid var(--ring); 
      border-radius: 14px; 
      box-shadow: var(--shadow-md); 
      padding: 20px; 
    }

    /* Day sections visibility */
    .day-section { display: none; }
    .day-section.active { display: block; }

    /* Skeleton loader */
    .skeleton { 
      display: grid; 
      gap: 16px; 
    }
    .s-card { 
      height: 140px; 
      border-radius: 14px; 
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%); 
      background-size: 400% 100%; 
      animation: shimmer 1.4s ease-in-out infinite; 
      border: 1px solid var(--ring); 
      box-shadow: var(--shadow-sm);
    }
    @keyframes shimmer { 
      0% { background-position: 100% 0 } 
      100% { background-position: 0 0 } 
    }

    /* Floating action buttons (copy) */
    .buttons-container { 
      position: fixed; 
      bottom: 28px; 
      right: 28px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    .action-button { 
      width: 84px; 
      height: 84px; 
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); 
      color: #fff; 
      border: 3px solid rgba(255,255,255,0.2); 
      border-radius: 50%; 
      font-size: 1.6rem; 
      cursor: pointer; 
      box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4), 0 2px 8px rgba(0,0,0,0.15); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transition: all .25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .action-button:hover { 
      transform: translateY(-3px) scale(1.05); 
      box-shadow: 0 12px 32px rgba(79, 70, 229, 0.5), 0 4px 12px rgba(0,0,0,0.2);
    }
    .loading { padding: 12px; color: #374151; }
    .error { padding: 12px; color: #b91c1c; font-weight: 600; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand"><span class="logo">ðŸŽ¾</span>SNV LT Schedule</div>
    <div class="actions">
      <button id="table-view-btn" class="secondary active">Table</button>
      <button id="plot-view-btn" class="secondary">Plot</button>
      <div class="segmented" id="week-toggle">
        <button id="week-all-btn">All Weeks</button>
        <button id="week-this-btn" class="active">This Week</button>
      </div>
      <button id="ann-btn">Announcements</button>
    </div>
  </div>
  <div class="app">
  <div id="tab-buttons" class="tab-buttons"></div>
  <div id="table-container" class="loading">Loading schedule...</div>
  <div id="original-table" style="display:none"></div>
  <div class="buttons-container">
    <button id="copy-fab" class="action-button" title="Copy Current Day">ðŸ“‹</button>
    <button id="copy-plot-button" class="action-button" title="Copy Plot" style="display:none">ðŸ–¼</button>
  </div>
  <div id="plot-container" style="display:none; width:100%; height:70vh; position:relative;">
    <div id="location-legend" style="position:absolute; right:12px; top:12px; background:rgba(255,255,255,0.85); padding:8px 12px; border-radius:8px;"></div>
    <canvas id="schedule-plot" style="width:100%; height:100%;"></canvas>
  </div>
  
  <!-- Footer with original data link -->
  <div style="text-align: center; padding: 2rem 1rem; margin-top: 3rem; border-top: 1px solid var(--ring);">
    <a href="https://docs.google.com/spreadsheets/d/1zpnq9KvS73oZ8SK1JbUaBuK9u9nv_3NArXW1Hy7Pkzs/edit?gid=0#gid=0" target="_blank" rel="noopener" style="color: var(--primary-700); text-decoration: none; font-size: 1.1rem; font-weight: 700; transition: color 0.2s ease;">View Original Data â†’</a>
  </div>
  <div id="announcement-modal" class="announcement-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1100;">
    <div class="announcement-content" style="width:min(680px,92vw); background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); max-height:80vh; overflow:auto;">
      <div class="announcement-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
        <h3 style="margin:0;">Schedule Announcements</h3>
        <button class="close-button" onclick="toggleAnnouncementModal()" style="border:none; background:#ef4444; color:#fff; border-radius:8px; padding:6px 10px; font-weight:700; cursor:pointer;">Ã—</button>
      </div>
      <div class="announcement-body">
        <div id="announcement-list" class="announcement-list" style="display:flex; flex-direction:column; gap:10px; margin-bottom:16px;"></div>
        <div class="add-announcement-section" style="border-top:1px solid #e5e7eb; padding-top:16px;">
          <h4 style="margin:0 0 10px 0;">Add New Announcement</h4>
          <textarea id="announcement-text" placeholder="Enter announcement text..." style="width:100%; min-height:80px; padding:8px; border:1px solid #e5e7eb; border-radius:8px;"></textarea>
          <div class="day-selector" style="margin-top:10px;">
            <div class="day-checkboxes" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
              <label><input type="checkbox" id="select-all-days" value="All"> All Days</label>
              <label><input type="checkbox" value="Sun"> Sun</label>
              <label><input type="checkbox" value="Mon"> Mon</label>
              <label><input type="checkbox" value="Tue"> Tue</label>
              <label><input type="checkbox" value="Wed"> Wed</label>
              <label><input type="checkbox" value="Thu"> Thu</label>
              <label><input type="checkbox" value="Fri"> Fri</label>
              <label><input type="checkbox" value="Sat"> Sat</label>
            </div>
          </div>
          <div class="announcement-buttons" style="margin-top:12px; display:flex; gap:10px;">
            <button onclick="addAnnouncement()">Add Announcement</button>
            <button onclick="clearAllAnnouncements()">Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script>
    const SHEET_ID = '1zpnq9KvS73oZ8SK1JbUaBuK9u9nv_3NArXW1Hy7Pkzs';
    const SHEET_NAMES = [
      'Fremont High School',
      'Sunnyvale Middle School (Mango)',
      'Serra Park',
      'Ortega Park',
      'Ponderosa Park',
      'Washington Park',
      'Braly Park',
      'Encinal Park',
      'Orchard Gardens',
      'Columbia Park',
      'Lakewood Park',
      'Fairwood Park',
      'Seven Seas'
    ];
    const expectedDays = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const weekdayOrder = {"Monday":1,"Tuesday":2,"Wednesday":3,"Thursday":4,"Friday":5,"Saturday":6,"Sunday":7};
    let CURRENT_DAY = '';
    let SHOW_WEEK_ONLY = true; // Default to showing only current week
    function csvUrlForSheet(name){return `https://r.jina.ai/http://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`}
    function parseCSV(csv){const lines=csv.trim().split(/\r?\n/);return lines.map(line=>{const res=[];let cell='';let q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){q=!q}else if(ch===','&&!q){res.push(cell.trim());cell=''}else{cell+=ch}}res.push(cell.trim());return res})}
    function processCourt(s){if(!s)return['Ct1'];if(s.trim().toUpperCase()==='N/A')return['N/A'];const cleaned=s.replace(/[^0-9,\-]/g,'').trim();if(!cleaned)return['Ct1'];const courts=[];const segs=cleaned.split(',').map(x=>x.trim()).filter(Boolean);segs.forEach(seg=>{if(seg.includes('-')){const[a,b]=seg.split('-').map(n=>parseInt(n.trim()));if(!isNaN(a)&&!isNaN(b)&&a<=b){for(let i=a;i<=b;i++)courts.push(i.toString())}else{courts.push(seg)}}else if(seg.length>1&&/^[1-9]+$/.test(seg)){seg.split('').forEach(d=>courts.push(d))}else{courts.push(seg)}});return[...new Set(courts.map(c=>`Ct${c}`))]}
    function compactCourtsDisplay(cs){if(cs.length<=1)return cs.join(', ');const nums=cs.map(c=>{const m=c.match(/(\d+)/);return m?parseInt(m[1]):null}).filter(n=>n!==null);if(nums.length!==cs.length)return cs.join(', ');nums.sort((a,b)=>a-b);const ranges=[];let s=nums[0],e=nums[0];for(let i=1;i<nums.length;i++){if(nums[i]===e+1)e=nums[i];else{ranges.push(s===e?`Ct${s}`:`Ct${s}-${e}`);s=e=nums[i]}}ranges.push(s===e?`Ct${s}`:`Ct${s}-${e}`);return ranges.join(', ')}
    function cleanSingleTime(t,ctx=null){if(!t)return'';const m=t.match(/([AP]M)/i);let p=m?m[1].toUpperCase():null;const cleaned=t.replace(/[^0-9:]/g,'');if(!cleaned)return'';let part=cleaned;if(!part.includes(':'))part=part+':00';const ps=part.split(':');if(ps.length<2)return'';let h=parseInt(ps[0]);let mi=parseInt(ps[1]);if(isNaN(h)||isNaN(mi)||h<0||h>23||mi<0||mi>59)return'';if(p){}else if(ctx)p=ctx;else{if(h===10)p='AM';else if(h>=9&&h<=11)p='AM';else if(h>=1&&h<=8)p='PM';else if(h===12)p='PM';else if(h===0)p='AM';else p='AM'}if(h>12){h-=12;p='PM'}if(h===0){h=12;p='AM'}mi=mi.toString().padStart(2,'0');return `${h}:${mi}${p}`}
    function format24to12Hour(h){let p='AM',h12=h;if(h>=12){p='PM';if(h>12)h12=h-12}if(h12===0)h12=12;return {hour:h12,period:p}}
    function processTimeRange(r,ctx=null){if(!r)return'';r=r.trim().replace(/;/g,':');const parts=r.split('-');if(parts.length===1){const rs=cleanSingleTime(parts[0],ctx);if(rs){const m=rs.match(/([AP]M)$/);const p=m?m[1]:ctx;return{result:rs,period:p}}return''}if(parts.length===2){const st=cleanSingleTime(parts[0],ctx);const sm=st.match(/([AP]M)$/);const sp=sm?sm[1]:ctx;const hasEnd=/[AP]M/i.test(parts[1]);let ectx=hasEnd?null:sp;if(sp==='AM'&&parts[1].trim().startsWith('12:'))ectx='PM';const et=cleanSingleTime(parts[1],ectx);if(!st||!et)return'';const sM=st.match(/(\d+):(\d+)([AP]M)/);const eM=et.match(/(\d+):(\d+)([AP]M)/);if(!sM||!eM)return'';let[,sh,smin,spm]=sM;let[,eh,emin,epm]=eM;sh=parseInt(sh);eh=parseInt(eh);let s24=sh,e24=eh;if(spm==='PM'&&s24!==12)s24+=12;if(epm==='PM'&&e24!==12)e24+=12;if(spm==='AM'&&s24===12)s24=0;if(epm==='AM'&&e24===12)e24=0;let len=e24-s24;if(len<0)len+=24;if(len>12){let newEnd=s24+2;if(newEnd>=24)newEnd-=24;const{hour,period}=format24to12Hour(newEnd);return{result:`${st}-${hour}:${emin}${period}`,period:spm}}return{result:`${st}-${et}`,period:spm}}return''}
    function processTime(t){if(!t)return'';t=t.replace(/,\s*$/,'').trim();const parts=t.split(/\s+/).filter(Boolean);const spaceMulti=parts.length>1&&parts.every(p=>p.includes('-'));let ranges=spaceMulti?parts:t.split(/[,;&]\s*/).filter(r=>r.trim());const out=[];let ctx=null;for(const r of ranges){const has=/[AP]M/i.test(r);const useCtx=!has?ctx:null;const res=processTimeRange(r.trim(),useCtx);if(res){if(typeof res==='string'){out.push(res);const m=res.match(/([AP]M)/);if(m)ctx=m[1]}else if(res.result){out.push(res.result);if(res.period)ctx=res.period}}}return out.join(', ')}
    function parseTimeToHours(s){if(!s)return null;s=s.trim();const m=s.match(/(\d+):(\d+)([AP]M)/i);if(!m)return null;let[,h,mi,p]=m;h=parseInt(h);mi=parseInt(mi);p=p.toUpperCase();if(p==='PM'&&h!==12)h+=12;if(p==='AM'&&h===12)h=0;return h+(mi/60)}
    function extractTimeRanges(t){if(!t)return[];t=t.replace(/,\s*$/,'').trim();const ranges=[];const parts=t.split(/[,;&]\s*/).filter(r=>r.trim());for(const r of parts){if(r.includes('-')){const seg=r.split('-');if(seg.length===2){const a=seg[0].trim();const b=seg[1].trim();const start=parseTimeToHours(a);const end=parseTimeToHours(b);if(start!==null&&end!==null)ranges.push({start,end})}}else{const single=parseTimeToHours(r.trim());if(single!==null)ranges.push({start:single,end:single+1})}}return ranges}
    function simplifyLocation(l){return l.replace('Fremont High School','Fremont').replace('Washington Park','Wash').replace('Ponderosa Park','Pond').replace('Sunnyvale Middle School','SMS').replace('Lakewood Park','Lakewood').replace('Serra Park','Serra').replace('Fairwood Park','Fairwood').replace('Ortega Park','Ortega').replace('Raynor Park','Raynor').replace('De Anza Park','DeAnza').replace('Sunnyvale Community Center','SCC').replace('Sunnyvale Tennis Center','STC').replace('Mango Park','Mango')}
    async function fetchOneSheet(name){
      // Try corsproxy first since jina.ai is rate-limited
      const urlPrimary = `https://corsproxy.io/?https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
      const urlFallback = `https://r.jina.ai/http://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
      let lastErr;
      for (const url of [urlPrimary, urlFallback]) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
          const text = await res.text();
          return { name, rows: parseCSV(text) };
        } catch (e) {
          lastErr = e;
          console.warn(`Failed to fetch ${name} from ${url}:`, e);
        }
      }
      throw lastErr || new Error(`All proxies failed for ${name}`);
    }
    async function getStoredTabNames(){try{const s=localStorage.getItem('sheetNames');if(!s)return null;const arr=JSON.parse(s);return Array.isArray(arr)&&arr.length?arr:null}catch(_){return null}}
    function setStoredTabNames(names){try{localStorage.setItem('sheetNames',JSON.stringify(names))}catch(_){}}
    async function discoverSheetNames(){try{const url=`https://r.jina.ai/http://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;const html=await fetch(url).then(r=>r.text());
      // Try to isolate the sheets metadata block first
      let names=[];
      const sheetsBlockMatch=html.match(/"sheets":\[(.*?)\]/s);
      const block=sheetsBlockMatch? sheetsBlockMatch[1] : html;
      const re=/"title":"([^"]+)"/g; let m; const seen=new Set();
      while((m=re.exec(block))!==null){const title=m[1].trim();if(title && !seen.has(title) && title.toLowerCase()!=='sheet1'){seen.add(title);names.push(title)}}
      // Fallback: scan for 'Day of the Week' header lines to capture location from header
      if(names.length===0){const reHeader=/\"([^"]+) Day of the Week\"/g; let h; const seen2=new Set(); while((h=reHeader.exec(html))!==null){const t=h[1].trim(); if(t && !seen2.has(t)){seen2.add(t); names.push(t)}}}
      setStoredTabNames(names); return names;
    }catch(e){console.warn('Tab discovery failed:', e); return []}}
    async function getSheetNames(){ if (Array.isArray(SHEET_NAMES) && SHEET_NAMES.length) return SHEET_NAMES; const stored=await getStoredTabNames(); if(stored) return stored; const names=await discoverSheetNames(); return names&&names.length?names:[] }
    async function fetchAllSheets(){const names=await getSheetNames(); if(!names || !names.length){return{successes:[],failures:[]}} const tasks=names.map(n=>fetchOneSheet(n).then(v=>({status:'fulfilled',value:v})).catch(e=>({status:'rejected',reason:e,name:n})));const results=await Promise.all(tasks);const successes=results.filter(r=>r.status==='fulfilled').map(r=>r.value);const failures=results.filter(r=>r.status==='rejected');return{successes,failures}}
    function normalizeDateStr(d){if(!d)return'';const p=d.split('/');if(p.length===2)return`${p[0]}/${p[1]}/2025`;if(p.length===3&&p[2].length===2)return`${p[0]}/${p[1]}/20${p[2]}`;return d}
    async function loadAndRender(){const container=document.getElementById('table-container');const tabs=document.getElementById('tab-buttons');const originalTable=document.getElementById('original-table');container.innerHTML='<div class="skeleton"><div class="s-card"></div><div class="s-card"></div><div class="s-card"></div></div>';tabs.innerHTML='';originalTable.innerHTML='';try{const{successes,failures}=await fetchAllSheets();if(successes.length===0){container.innerHTML=`<div class="error">No sheets loaded. Click 'Scan Tabs' or check sharing.</div>`;return}let rawData=[];for(const sheet of successes){const sheetName=sheet.name; // discovered title
      // Derive display location from the header cell like "<Location> Day of the Week" or "<Location> Monday Tuesday..."
      let displayLocation=sheetName; 
      if(sheet.rows&&sheet.rows.length>0&&sheet.rows[0]&&sheet.rows[0][0]){
        let hdr=sheet.rows[0][0].trim();
        console.log('Processing header for sheet', sheetName, ':', hdr);
        
        // First, remove "Day of the Week" if present
        if(/day of the week/i.test(hdr)){
          hdr=hdr.replace(/day of the week/i,'').trim();
          console.log('After removing "Day of the Week":', hdr);
        }
        
        // Then remove all day names from the string (whether or not "Day of the Week" was present)
        const cleanedHeader=hdr.replace(/\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/gi,'').replace(/\s+/g,' ').trim();
        console.log('After removing day names:', cleanedHeader);
        
        // Use cleaned header if it's not empty, otherwise use sheet name
        if(cleanedHeader&&cleanedHeader.length>0){
          displayLocation=cleanedHeader;
          console.log('Using cleaned header:', displayLocation);
        } else {
          displayLocation=sheetName;
          console.log('Cleaned header empty, using sheet name:', displayLocation);
        }
        
        // Final fallback: if displayLocation is empty or just whitespace, use sheet name
        if(!displayLocation||displayLocation.trim().length===0){
          displayLocation=sheetName;
          console.log('Display location was empty, falling back to sheet name:', displayLocation);
        }
      }
      console.log('Final displayLocation for', sheetName, ':', displayLocation);
      let lastDay='';let lastDate='';
      for(const row of sheet.rows){if(row.length<5)continue;let[V1,V2,V3,V4,V5]=row.map(c=>c?c.trim():'');const headerCell=V1||'';if(/day of the week/i.test(headerCell)||V2==='Date')continue;if(!V1)V1=lastDay;else lastDay=V1;if(!V2)V2=lastDate;else lastDate=V2;if(!expectedDays.includes(V1))continue;if(!V4&&V3)V4='N/A';if(!V4&&!V3)continue;const d=normalizeDateStr(V2);const dateObj=new Date(d);const courts=processCourt(V4);courts.forEach(court=>{rawData.push({Day:V1,Date:d,DateObj:dateObj,RawTime:V3,Time:processTime(V3),RawCourt:V4,Court:court,Location:displayLocation})})}}
    const combined={};rawData.forEach(item=>{const key=`${item.Day}|${item.Date}|${item.Location}|${item.Court}|${item.Time}`;if(!combined[key])combined[key]={...item,Times:[item.Time]};else if(!combined[key].Times.includes(item.Time))combined[key].Times.push(item.Time)});let cleaned=Object.values(combined).map(it=>({...it,Time:it.Times.join(', ')}));
    // Filter by current week if enabled
    if(SHOW_WEEK_ONLY){const now=new Date();const dayOfWeek=now.getDay();const startOfWeek=new Date(now);startOfWeek.setDate(now.getDate()-dayOfWeek);startOfWeek.setHours(0,0,0,0);const endOfWeek=new Date(startOfWeek);endOfWeek.setDate(startOfWeek.getDate()+6);endOfWeek.setHours(23,59,59,999);cleaned=cleaned.filter(r=>r.DateObj>=startOfWeek&&r.DateObj<=endOfWeek)}
    cleaned.sort((a,b)=>{if(weekdayOrder[a.Day]!==weekdayOrder[b.Day])return weekdayOrder[a.Day]-weekdayOrder[b.Day];if(b.DateObj-a.DateObj!==0)return b.DateObj-a.DateObj;if(a.Location!==b.Location)return a.Location.localeCompare(b.Location);const aNum=parseInt(a.Court.replace(/\D/g,''))||0;const bNum=parseInt(b.Court.replace(/\D/g,''))||0;return aNum-bNum});const grouped={};cleaned.forEach(r=>{if(!grouped[r.Day])grouped[r.Day]={};if(!grouped[r.Day][r.Date])grouped[r.Day][r.Date]=[];grouped[r.Day][r.Date].push(r)});
    container.innerHTML='';tabs.innerHTML='';for(const day of expectedDays){if(!grouped[day])continue;const btn=document.createElement('button');btn.textContent=day;btn.onclick=()=>switchTab(day);tabs.appendChild(btn);const section=document.createElement('div');section.id=`section-${day}`;section.className='day-section';for(const date of Object.keys(grouped[day]).sort((a,b)=>new Date(b)-new Date(a))){const dateTitle=document.createElement('div');dateTitle.className='date-title';dateTitle.textContent=date;section.appendChild(dateTitle);const table=document.createElement('table');const thead=document.createElement('thead');const headRow=document.createElement('tr');['Location','Courts','Time'].forEach(h=>{const th=document.createElement('th');th.textContent=h;headRow.appendChild(th)});thead.appendChild(headRow);table.appendChild(thead);const tbody=document.createElement('tbody');
    // First pass: group by Location|Time to combine courts at same time
    const timeGroups={};grouped[day][date].forEach(r=>{const k=`${r.Location}|${r.Time}`;if(!timeGroups[k])timeGroups[k]={Location:r.Location,Courts:[],Time:r.Time};timeGroups[k].Courts.push(r.Court)});
    // Second pass: group by Location|Courts to combine times for same courts
    const finalGroups={};Object.values(timeGroups).forEach(g=>{const courtsKey=compactCourtsDisplay(g.Courts);const k=`${g.Location}|${courtsKey}`;if(!finalGroups[k])finalGroups[k]={Location:g.Location,Courts:courtsKey,Times:[]};if(!finalGroups[k].Times.includes(g.Time))finalGroups[k].Times.push(g.Time)});
    // Sort and render
    Object.values(finalGroups).sort((a,b)=>{if(a.Location!==b.Location)return a.Location.localeCompare(b.Location);return a.Courts.localeCompare(b.Courts)}).forEach(g=>{
      // Sort times chronologically
      g.Times.sort((a,b)=>{const aHour=parseTimeToHours(a.split(',')[0].split('-')[0].trim());const bHour=parseTimeToHours(b.split(',')[0].split('-')[0].trim());return (aHour||0)-(bHour||0)});
      const tr=document.createElement('tr');const tdLoc=document.createElement('td');tdLoc.textContent=g.Location;tr.appendChild(tdLoc);const tdCourt=document.createElement('td');tdCourt.textContent=g.Courts;tr.appendChild(tdCourt);const tdTime=document.createElement('td');tdTime.textContent=g.Times.join(', ');tr.appendChild(tdTime);tbody.appendChild(tr)});table.appendChild(tbody);section.appendChild(table)}container.appendChild(section)}
    const tbody=document.createElement('tbody');cleaned.forEach(r=>{const tr=document.createElement('tr');['Day','Date','Time','Court','Location'].forEach(k=>{const td=document.createElement('td');td.textContent=r[k];tr.appendChild(td)});tbody.appendChild(tr)});originalTable.appendChild(tbody);
    let initialDayName = expectedDays[new Date().getDay()];
    const defaultDay = grouped[initialDayName] ? initialDayName : expectedDays.find(d => grouped[d]);
    if (defaultDay) {
      switchTab(defaultDay);
      const tabContainer = document.querySelector('.tab-buttons');
      if (tabContainer) tabContainer.setAttribute('data-day', defaultDay.substring(0,3));
    }
    if(failures.length){console.warn('Sheets failed to load:',failures.map(f=>f.name||f))}}catch(e){console.error('Failed to load:',e);container.innerHTML=`<div class="error">Could not load schedule. Please check network or sheet access.</div>`}}
    function switchTab(day){
      // Hide all sections and remove active markers
      document.querySelectorAll('.day-section').forEach(sec=>{ sec.classList.remove('active'); sec.style.display='none'; });
      document.querySelectorAll('.tab-buttons button').forEach(btn=>btn.classList.remove('active'));
      // Activate selected
      const section=document.getElementById(`section-${day}`);
      if(section){ section.classList.add('active'); section.style.display='block'; }
      const btn=Array.from(document.getElementById('tab-buttons').children).find(b=>b.textContent===day);
      if(btn)btn.classList.add('active');
      CURRENT_DAY=day;
      const tabContainer=document.querySelector('.tab-buttons');
      if(tabContainer)tabContainer.setAttribute('data-day', day.substring(0,3));
      // Respect current view
      const isPlotView=document.getElementById('plot-view-btn').classList.contains('active');
      if(isPlotView){
        document.getElementById('table-container').style.display='none';
        document.getElementById('plot-container').style.display='block';
        document.getElementById('copy-plot-button').style.display='flex';
        createPlot(day,false)
      }else{
        document.getElementById('table-container').style.display='block';
        document.getElementById('plot-container').style.display='none';
        document.getElementById('copy-plot-button').style.display='none'
      }
    }
    function normalizeDate(dateStr){const parts=dateStr.split('/');const m=parseInt(parts[0]);const d=parseInt(parts[1]);const y=parts[2]?parseInt(parts[2]):new Date().getFullYear();return `${m}/${d}/${y}`}
    function getCopyTextForDay(day){
      const originalTable=document.getElementById('original-table');
      const rows=Array.from(originalTable.querySelectorAll('tbody tr'));
      const dayRows=rows.filter(r=>(r.querySelectorAll('td')[0]?.textContent.trim()===day));
      const dateGroups={};
      
      // Group by date, location, and collect court/time pairs
      dayRows.forEach(row=>{
        const cells=Array.from(row.querySelectorAll('td'));
        const date=normalizeDate(cells[1].textContent.trim());
        const location=cells[4].textContent.trim();
        const court=cells[3].textContent.trim();
        const time=cells[2].textContent.trim();
        if(!time||time.trim()==='')return;
        if(!dateGroups[date])dateGroups[date]={};
        if(!dateGroups[date][location])dateGroups[date][location]=[];
        dateGroups[date][location].push({court,time});
      });
      
      const today=new Date();
      today.setHours(0,0,0,0);
      let todayData='';
      let otherData='';
      let todayDateDisplay='';
      
      Object.entries(dateGroups).forEach(([date,locations])=>{
        const parts=date.split('/').map(x=>parseInt(x));
        const dateObj=new Date(parts[2],parts[0]-1,parts[1]);
        dateObj.setHours(0,0,0,0);
        const dateDisplay=`${parts[0]}/${parts[1]}`;
        const isToday=dateObj.getTime()===today.getTime();
        if(isToday)todayDateDisplay=dateDisplay;
        
        let sectionText='';
        const sortedLocations=Object.keys(locations).sort();
        
        sortedLocations.forEach((location,index)=>{
          const locationData=locations[location];
          const datePrefix=isToday?'':` (${dateDisplay})`;
          
          // Group courts by time
          const timeGroups={};
          locationData.forEach(item=>{
            if(!item.time||item.time.trim()==='')return;
            if(!timeGroups[item.time])timeGroups[item.time]=[];
            timeGroups[item.time].push(item.court);
          });
          
          const timeEntries=Object.entries(timeGroups);
          if(timeEntries.length===0)return;
          
          const simpleLocation=simplifyLocation(location);
          
          // Format: if single time, inline; if multiple times, multi-line
          if(timeEntries.length===1){
            const[time,courts]=timeEntries[0];
            sectionText+=`${simpleLocation}${datePrefix}: ${courts.join(', ')}: ${time}\n`;
          }else{
            sectionText+=`${simpleLocation}${datePrefix}:\n`;
            timeEntries.forEach(([time,courts])=>{
              sectionText+=`  ${courts.join(', ')}: ${time}\n`;
            });
          }
          
          if(index<sortedLocations.length-1){
            sectionText+='\n';
          }
        });
        
        if(isToday){
          todayData=sectionText;
        }else{
          otherData+=sectionText;
        }
      });
      
      const announcementText=getAnnouncementText(day);
      const text=`SNV LT æ•™ç»ƒå åœºä¿¡æ¯ ${day} ${todayDateDisplay}\n${todayData}${otherData}${announcementText}`;
      return text;
    }
document.getElementById('copy-fab').addEventListener('click',()=>{if(!CURRENT_DAY)return;const text=getCopyTextForDay(CURRENT_DAY);navigator.clipboard.writeText(text)});
document.getElementById('ann-btn').addEventListener('click',()=>toggleAnnouncementModal());
document.getElementById('table-view-btn').addEventListener('click',()=>{document.getElementById('table-container').style.display='block';document.getElementById('plot-container').style.display='none';document.getElementById('table-view-btn').classList.add('active');document.getElementById('plot-view-btn').classList.remove('active');document.getElementById('copy-plot-button').style.display='none'});
document.getElementById('plot-view-btn').addEventListener('click',()=>{document.getElementById('table-container').style.display='none';document.getElementById('plot-container').style.display='block';document.getElementById('table-view-btn').classList.remove('active');document.getElementById('plot-view-btn').classList.add('active');document.getElementById('copy-plot-button').style.display='flex';if(CURRENT_DAY)createPlot(CURRENT_DAY,false)});
let __resizeTimer;window.addEventListener('resize',()=>{clearTimeout(__resizeTimer);__resizeTimer=setTimeout(()=>{const isPlot=document.getElementById('plot-view-btn').classList.contains('active');if(isPlot&&CURRENT_DAY)createPlot(CURRENT_DAY,false)},250)});
document.getElementById('copy-plot-button').addEventListener('click',copyPlotToClipboard);
// Expand/collapse day bubble and close on outside click
document.addEventListener('DOMContentLoaded',function(){
  const tabButtons=document.querySelector('.tab-buttons');
  if(tabButtons){
    tabButtons.addEventListener('click',function(e){ if(e.target===this) this.classList.toggle('expanded'); });
    document.addEventListener('click',function(e){ if(!tabButtons.contains(e.target)) tabButtons.classList.remove('expanded'); });
  }
});
loadAndRender();

function toggleAnnouncementModal() {
  const modal = document.getElementById('announcement-modal');
  const isVisible = modal.style.display === 'flex';
  modal.style.display = isVisible ? 'none' : 'flex';
  if (!isVisible) {
    renderAnnouncements();
    setupDaySelector();
  }
}

function loadAnnouncements() {
  try {
    const stored = localStorage.getItem('announcements');
    return stored ? JSON.parse(stored) : [];
  } catch (e) {
    console.error('Failed to load announcements:', e);
    return [];
  }
}

function saveAnnouncements(announcements) {
  try {
    localStorage.setItem('announcements', JSON.stringify(announcements));
  } catch (e) {
    console.error('Failed to save announcements:', e);
  }
}

function renderAnnouncements() {
  const announcements = loadAnnouncements();
  const list = document.getElementById('announcement-list');
  list.innerHTML = announcements.map((ann, idx) => `
    <div class="announcement-item" style="padding:10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">
      <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
        <div style="flex:1;">
          <div style="font-weight:600; margin-bottom:4px;">${ann.days.join(', ')}</div>
          <div style="color:#6b7280;">${ann.text}</div>
        </div>
        <button class="delete-btn" onclick="deleteAnnouncement(${idx})">Delete</button>
      </div>
    </div>
  `).join('');
}

function setupDaySelector() {
  const selectAll = document.getElementById('select-all-days');
  const dayBoxes = document.querySelectorAll('.day-checkboxes input[type="checkbox"]:not(#select-all-days)');
  selectAll.addEventListener('change', function() { dayBoxes.forEach(cb => cb.checked = this.checked); });
  dayBoxes.forEach(cb => {
    cb.addEventListener('change', function() {
      const allChecked = Array.from(dayBoxes).every(x => x.checked);
      const noneChecked = Array.from(dayBoxes).every(x => !x.checked);
      if (allChecked) { selectAll.checked = true; selectAll.indeterminate = false; }
      else if (noneChecked) { selectAll.checked = false; selectAll.indeterminate = false; }
      else { selectAll.checked = false; selectAll.indeterminate = true; }
    });
  });
}

function getSelectedDays() {
  const dayBoxes = document.querySelectorAll('.day-checkboxes input[type="checkbox"]:not(#select-all-days)');
  const selected = Array.from(dayBoxes).filter(cb => cb.checked).map(cb => cb.value);
  return document.getElementById('select-all-days').checked ? ['All'] : selected;
}

function addAnnouncement() {
  const textarea = document.getElementById('announcement-text');
  const text = (textarea.value || '').trim();
  if (!text) return;
  const days = getSelectedDays();
  if (days.length === 0) {
    alert('Please select at least one day');
    return;
  }
  const announcements = loadAnnouncements();
  announcements.push({ text, days });
  saveAnnouncements(announcements);
  renderAnnouncements();
  clearForm();
}

function editAnnouncement(idx) {
  const announcements = loadAnnouncements();
  const ann = announcements[idx];
  if (!ann) return;
  document.getElementById('announcement-text').value = ann.text;
  const dayBoxes = document.querySelectorAll('.day-checkboxes input[type="checkbox"]:not(#select-all-days)');
  dayBoxes.forEach(cb => {
    cb.checked = ann.days.includes('All') || ann.days.includes(cb.value);
  });
  deleteAnnouncement(idx);
}

function deleteAnnouncement(idx) {
  const announcements = loadAnnouncements();
  announcements.splice(idx, 1);
  saveAnnouncements(announcements);
  renderAnnouncements();
}

function clearAllAnnouncements() {
  if (confirm('Are you sure you want to clear all announcements?')) {
    saveAnnouncements([]);
    renderAnnouncements();
  }
}

function clearForm() {
  document.getElementById('announcement-text').value = '';
  document.querySelectorAll('.day-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function getAnnouncementsForDay(day) {
  const announcements = loadAnnouncements();
  return announcements.filter(ann => ann.days.includes('All') || ann.days.some(d => day.startsWith(d)));
}

function getAnnouncementText(day) {
  const announcements = getAnnouncementsForDay(day);
  if (announcements.length === 0) return '';
  return '\n\nðŸ“¢ Announcements:\n' + announcements.map(ann => `â€¢ ${ann.text}`).join('\n');
}

function showNotification(message) {
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;';
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 2000);
}
    async function copyPlotToClipboard(){const canvas=document.getElementById('schedule-plot');try{if(typeof ClipboardItem!=='undefined'&&navigator.clipboard.write){const blob=await new Promise(res=>canvas.toBlob(res));await navigator.clipboard.write([new ClipboardItem({'image/png':blob})])}}catch(e){console.error(e)}}
    function createPlot(day,forCopy=false){
      if(!day)return;
      const canvas=document.getElementById('schedule-plot');
      const ctx=canvas.getContext('2d');
      
      // Get data from original table
      const originalTable=document.getElementById('original-table');
      const rows=Array.from(originalTable.querySelectorAll('tbody tr'));
      const dayData=rows.filter(row=>{
        const cells=Array.from(row.querySelectorAll('td'));
        return cells[0]?.textContent.trim()===day;
      });
      
      // Group by location and court
      const courtsMap={};
      dayData.forEach(row=>{
        const cells=Array.from(row.querySelectorAll('td'));
        if(cells.length<5)return;
        const location=cells[4].textContent.trim();
        const court=cells[3].textContent.trim();
        const time=cells[2].textContent.trim();
        if(!time||!time.trim())return;
        
        const key=`${location}|||${court}`;
        if(!courtsMap[key]){
          courtsMap[key]={
            location:location,
            court:court,
            times:[]
          };
        }
        
        const ranges=extractTimeRanges(time);
        courtsMap[key].times.push(...ranges);
      });
      
      // Convert to array and sort
      const courtsList=Object.values(courtsMap)
        .filter(c=>c.times.length>0)
        .sort((a,b)=>{
          if(a.location!==b.location)return a.location.localeCompare(b.location);
          const aNum=parseInt(a.court.match(/\d+/)?.[0])||0;
          const bNum=parseInt(b.court.match(/\d+/)?.[0])||0;
          return aNum-bNum;
        });
      
      // Create labels for Y-axis
      const yLabels=courtsList.map(c=>`${simplifyLocation(c.location)} ${c.court}`);
      
      // Calculate time bounds
      let minTime=24,maxTime=0;
      courtsList.forEach(court=>{
        court.times.forEach(t=>{
          if(t.start<minTime)minTime=t.start;
          if(t.end>maxTime)maxTime=t.end;
        });
      });
      minTime=Math.max(8,Math.floor(minTime-0.5));
      maxTime=Math.min(22,Math.ceil(maxTime+0.5));
      
      // Create color map
      const locations=[...new Set(courtsList.map(c=>c.location))];
      const colors=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#e67e22'];
      const colorMap={};
      locations.forEach((loc,i)=>colorMap[loc]=colors[i%colors.length]);
      
      // Create datasets - one per time slot
      const allData=[];
      courtsList.forEach((court,idx)=>{
        court.times.forEach(timeRange=>{
          allData.push({
            x:[timeRange.start,timeRange.end],
            y:yLabels[idx],
            backgroundColor:colorMap[court.location],
            borderColor:'rgba(255,255,255,0.6)',
            borderWidth:1,
            barThickness:44
          });
        });
      });
      
      // Single dataset with all bars
      const datasets=[{
        data:allData,
        backgroundColor:allData.map(d=>d.backgroundColor),
        borderColor:allData.map(d=>d.borderColor),
        borderWidth:1,
        barThickness:44,
        borderRadius:22,
        borderSkipped:false,
        categoryPercentage:0.95,
        barPercentage:0.95
      }];
      
      // Destroy old chart
      if(window.scheduleChart)window.scheduleChart.destroy();
      
      // Create chart
      window.scheduleChart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:yLabels,
          datasets:datasets
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          elements:{
            bar:{
              borderRadius:22,
              borderSkipped:false
            }
          },
          datasets:{
            bar:{
              borderRadius:22,
              borderSkipped:false,
              categoryPercentage:0.95,
              barPercentage:0.95,
              barThickness:44,
              maxBarThickness:48
            }
          },
          scales:{
            x:{
              type:'linear',
              min:minTime,
              max:maxTime,
              ticks:{
                stepSize:1,
                callback:v=>{
                  const h=Math.floor(v);
                  if(h===12)return'12PM';
                  if(h>12)return`${h-12}PM`;
                  return`${h}AM`;
                }
              },
              title:{display:true,text:'Time'}
            },
            y:{
              type:'category',
              labels:yLabels,
              ticks:{
                font:{size:11,weight:'600'}
              }
            }
          },
          plugins:{
            legend:{display:false},
            tooltip:{
              callbacks:{
                label:ctx=>{
                  const d=ctx.raw;
                  const formatTime=h=>{
                    const hr=Math.floor(h);
                    const min=Math.round((h-hr)*60);
                    const h12=hr>12?hr-12:(hr===0?12:hr);
                    const p=hr>=12?'PM':'AM';
                    return min===0?`${h12}${p}`:`${h12}:${min.toString().padStart(2,'0')}${p}`;
                  };
                  return`${formatTime(d.x[0])}-${formatTime(d.x[1])}`;
                }
              }
            }
          }
        }
      });
      
      // Hide legend
      document.getElementById('location-legend').style.display='none';
    }

    // Week toggle wiring
    function updateWeekToggleUI(){
      const allBtn=document.getElementById('week-all-btn');
      const thisBtn=document.getElementById('week-this-btn');
      if(!allBtn||!thisBtn) return;
      if(SHOW_WEEK_ONLY){
        thisBtn.classList.add('active');
        allBtn.classList.remove('active');
      }else{
        allBtn.classList.add('active');
        thisBtn.classList.remove('active');
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      // Attach week segmented toggle
      const allBtn=document.getElementById('week-all-btn');
      const thisBtn=document.getElementById('week-this-btn');
      if(allBtn) allBtn.addEventListener('click',()=>{ if(SHOW_WEEK_ONLY){ SHOW_WEEK_ONLY=false; updateWeekToggleUI(); loadAndRender(); }});
      if(thisBtn) thisBtn.addEventListener('click',()=>{ if(!SHOW_WEEK_ONLY){ SHOW_WEEK_ONLY=true; updateWeekToggleUI(); loadAndRender(); }});
      updateWeekToggleUI();
    });
  </script>
</body>
</html>
